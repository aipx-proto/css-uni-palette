<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSS UniPalette</title>
  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>

  <style id="app-styles">
    html {
      --app-background-color: hsl(0, 0%, 2%);
      --app-background-color-input: hsl(0, 0%, 0%);
      --app-text-color: #eee;
      color: var(--app-text-color);
      background-color: var(--app-background-color);
      color-scheme: dark;
    }

    html:has(.APPSETTING-light-theme) {
      --app-background-color: hsl(0, 0%, 98%);
      --app-background-color-input: hsl(0, 0%, 96%);
      --app-text-color: #111;
      color: var(--app-text-color);
      background-color: var(--app-background-color);
      color-scheme: light;
    }

    body,
    html {
      --font-family-monospace: ui-monospace, menlo, monaco, consolas, monospace;
      font-family: system-ui, -apple-system, sans-serif;
      font-size: 12px;

      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }

    * {
      box-sizing: border-box;
    }

    .title-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      position: sticky;
      top: 0;
      /* Use a semi-transparent background to let the blur show through */
      background-color: oklch(from var(--app-background-color) l c h / 0.8);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--app-background-color);
      z-index: 10;
      flex: 0 0 auto;
    }

    .title-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .title {
      font-size: 16px;
      font-weight: 700;
      margin: 0;
    }

    .export-btn {
      padding: 6px 12px;
      border: 1px solid oklch(from currentColor l 0 0 / 0.2);
      border-radius: 4px;
      background: transparent;
      color: inherit;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .export-btn:hover {
      border-color: oklch(from currentColor l 0 0 / 0.4);
      background: oklch(from currentColor l 0 0 / 0.05);
    }

    .controls {
      display: flex;
      gap: 32px;
      align-items: center;
    }

    .grid-container {
      flex: 1 1 auto;
      display: grid;
    }

    .color-grid {
      display: grid;
      grid-template-columns: auto repeat(12, 1fr);
      gap: 2px 0px;
      padding: 2px;
      width: 100%;
      font-family: var(--font-family-monospace);

      >* {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px;
        gap: 2px;
      }
    }

    .color-cell,
    .color-name,
    .header-cell {
      --swatch: gray;
      /* eventually, this would be `contrast-color(var(--swatch))`: https://developer.mozilla.org/en-US/docs/Web/CSS/color_value/contrast-color */
      --contrast-color: hwb(from oklch(from var(--swatch) l 0 0) h calc(((b - 50) * 999)) calc(((w - 50) * 999)));
      background-color: var(--swatch);
      color: oklch(from var(--contrast-color) l 0 0 / 0.7);
    }

    body.APPSETTING-show-as-text .color-cell,
    body.APPSETTING-show-as-text .header-cell,
    body.APPSETTING-show-as-text .color-name {
      color: var(--swatch);
      background: hsl(0, 0%, 50%, 0.1);
      /* background-color: color-mix(in hsl, var(--contrast-color) .1%, hsl(0, 0%, 50%)); */
    }

    .color-cell {
      min-height: 24px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .header-cell {
      --l-shade: var(--l-500);
      --swatch: oklch(from black var(--l-shade) 0 0);
      font-weight: 600;
    }

    .color-name {
      font-weight: 600;
      text-transform: capitalize;
      gap: 8px;
      /* color: var(--app-text-color); */
    }

    .color-input {
      width: 24px;
      height: 16px;
      border: none;
      border-radius: 2px;
      cursor: pointer;
      background: transparent;
    }

    .color-input::-webkit-color-swatch-wrapper {
      padding: 0;
      border: none;
      border-radius: 2px;
    }

    .color-input::-webkit-color-swatch {
      border: 1px solid hsl(from currentColor l 0 0 / 0.2);
      border-radius: 2px;
    }

    .lightness-input {
      width: 8ch;
      height: 2em;
      min-width: 0;
      flex: 0 0 auto;
      /* align-self: stretch; */
      border-radius: 2px;
      color: inherit;
      background: transparent;
      border: 1px solid oklch(from currentColor l 0 0 / 0.1);
      padding-left: 8px;
      font-size: inherit;
      font-family: inherit;
    }

    .lightness-input:focus {
      border: 1px solid oklch(from currentColor l 0 0 / 0.6);
      outline: none;
    }

    .dialog {
      width: 90vw;
      max-height: 90vh;
      overflow: hidden;
      border: 1px solid oklch(from currentColor l 0 0 / 0.2);
      border-radius: 8px;
      background: var(--app-background-color);
      color: inherit;
      padding: 0;
      font-family: var(--font-family-monospace);
    }

    .dialog::backdrop {
      background: rgba(0, 0, 0, 0.7);
    }

    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid oklch(from currentColor l 0 0 / 0.1);
    }

    .dialog-title {
      font-size: 16px;
      font-weight: 700;
      margin: 0;
    }

    .close-btn {
      background: none;
      border: none;
      color: inherit;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .close-btn:hover {
      background: oklch(from currentColor l 0 0 / 0.1);
    }

    .dialog-content {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
      max-height: 80vh;
    }

    .css-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .css-section h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: oklch(from currentColor l 0 0 / 0.8);
    }

    .css-section label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      color: oklch(from currentColor l 0 0 / 0.9);
    }

    .css-section textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      background: var(--app-background-color-input);
      border: 1px solid oklch(from currentColor l 0 0 / 0.2);
      border-radius: 4px;
      color: inherit;
      font-family: var(--font-family-monospace);
      font-size: 12px;
      line-height: 1.4;

      /* resize: vertical; */
      field-sizing: content;
    }

    .css-section textarea:focus {
      border-color: oklch(from currentColor l 0 0 / 0.4);
      outline: none;
    }

    .css-section select,
    .css-section input[type="number"] {
      padding: 8px 12px;
      background: var(--app-background-color-input);
      border: 1px solid oklch(from currentColor l 0 0 / 0.2);
      border-radius: 4px;
      color: inherit;
      font-size: 13px;
    }

    .css-section select:focus,
    .css-section input[type="number"]:focus {
      border-color: oklch(from currentColor l 0 0 / 0.4);
      outline: none;
    }

    .settings-controls-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .settings-controls-row .css-section {
      flex: 1;
      min-width: 200px;
    }

    .settings-divider {
      border: none;
      border-top: 1px solid oklch(from currentColor l 0 0 / 0.1);
      margin: 20px 0;
    }

    .settings-textareas-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .settings-textareas-row .css-section {
      flex: 1;
      min-width: 280px;
    }

    .export-format-selector {
      margin-bottom: 0;
    }

    .export-controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .radio-option input[type="radio"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .radio-option:hover {
      color: oklch(from currentColor l 0 0 / 0.8);
    }

    .css-section pre {
      background: var(--app-background-color-input);
      border: 1px solid oklch(from currentColor l 0 0 / 0.1);
      border-radius: 4px;
      padding: 16px;
      margin: 0;
      font-family: var(--font-family-monospace);
      font-size: 12px;
      line-height: 1.4;
      overflow-x: auto;
      white-space: pre-wrap;
    }

    .about-content {
      line-height: 1.6;
    }

    .about-content h3 {
      margin: 24px 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: oklch(from currentColor l 0 0 / 0.9);
    }

    .about-content p {
      margin: 0 0 16px 0;
      color: oklch(from currentColor l 0 0 / 0.8);
    }

    .about-content ul {
      margin: 0 0 16px 0;
      padding-left: 20px;
    }

    .about-content li {
      margin: 8px 0;
      color: oklch(from currentColor l 0 0 / 0.8);
    }

    .about-content code {
      background: var(--app-background-color-input);
      border: 1px solid oklch(from currentColor l 0 0 / 0.1);
      border-radius: 3px;
      padding: 2px 6px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
    }

    .about-content pre {
      background: var(--app-background-color-input);
      border: 1px solid oklch(from currentColor l 0 0 / 0.1);
      border-radius: 4px;
      padding: 12px;
      margin: 12px 0;
      overflow-x: auto;
    }

    .about-content a {
      color: oklch(from currentColor l 0 0 / 0.9);
      text-decoration: underline;
    }

    .about-content a:hover {
      color: oklch(from currentColor l 0 0);
    }

    .control-group {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 4px;
    }

    .control-group label {
      font-weight: 600;
      margin: 0;
    }

    .control-group input {
      width: 80px;
      height: 6px;
      cursor: pointer;
    }

    .control-group span {
      min-width: 24px;
      text-align: center;
    }

    /* Visual settings classes */
    body:not(.APPSETTING-show-labels):not(.APPSETTING-show-as-text) .color-cell:not(.color-name):not(:hover) {
      color: transparent;
    }

    body.APPSETTING-space-cells .color-grid {
      gap: 2px;
    }

    .visual-settings-row {
      display: flex;
      gap: 24px;
      align-items: center;
      margin-bottom: 20px;
    }

    .visual-setting {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }

    .visual-setting input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .visual-setting:hover {
      color: oklch(from currentColor l 0 0 / 0.8);
    }
  </style>
</head>

<body>
  <div class="title-bar">
    <div class="title-section">
      <h1 class="title">CSS UniPalette</h1>
    </div>
    <div class="title-section">
      <div class="controls">
        <div class="control-group">
          <label for="hue-torsion">Hue Torsion</label>
          <input type="range" id="hue-torsion" min="-50" max="50" value="0" oninput="updateHueTorsion(this.value)">
          <span id="hue-value">0</span>
        </div>
        <div class="control-group">
          <label for="chroma-reduction">Chroma Reduction</label>
          <input type="range" id="chroma-reduction" min="0" max="100" value="50"
            oninput="updateChromaReduction(this.value)">
          <span id="chroma-value">50</span>
        </div>
        <button class="export-btn" onclick="openSettingsDialog()">Settings</button>
      </div>
      <span>|</span>
      <button class="export-btn" onclick="openExportDialog()">Export</button>
      <button class="export-btn" onclick="openAboutDialog()">About</button>
    </div>
  </div>

  <div class="grid-container" id="color-grid-container">
  </div>

  <dialog class="dialog" id="about-dialog">
    <div class="dialog-header">
      <h2 class="dialog-title">About CSS UniPalette</h2>
      <button class="close-btn" onclick="closeAboutDialog()">&times;</button>
    </div>
    <div class="dialog-content">
      <div class="about-content">
        <p>This tool demonstrates CSS-only color palette generation using the new <strong>relative color syntax</strong>
          with <code>oklch()</code> color space.</p>

        <h3>How It Works</h3>
        <p>Each color variation is calculated from source colors using CSS custom properties and relative color
          functions:</p>
        <ul>
          <li><strong>Lightness Scale</strong>: Controls the brightness levels (50, 100, 200... 950)</li>
          <li><strong>Hue Torsion</strong>: Shifts colors around the color wheel</li>
          <li><strong>Chroma Reduction</strong>: Adjusts color saturation across different shades</li>
        </ul>

        <h3>Interactive Features</h3>
        <ul>
          <li><strong>Color Inputs</strong>: Click color swatches in the first column to change source colors</li>
          <li><strong>Lightness Inputs</strong>: Edit numeric values in header cells to adjust brightness levels</li>
          <li><strong>Global Controls</strong>: Use sliders to apply hue shifts and chroma adjustments</li>
          <li><strong>Export</strong>: Generate copy-ready CSS for your projects</li>
        </ul>

        <h3>CSS Relative Colors</h3>
        <p>This technique uses the new CSS relative color syntax:</p>
        <pre>oklch(from var(--source-color) var(--lightness) calc(chroma-adjustment) calc(hue-adjustment))</pre>

        <p>This allows for pure CSS color manipulation without JavaScript preprocessing, enabling dynamic theming and
          real-time color system updates.</p>

        <h3>Browser Support</h3>
        <p>Relative color syntax is supported in modern browsers. For production use, check <a
            href="https://caniuse.com/css-relative-colors" target="_blank" rel="noopener">current browser support</a>.
        </p>
      </div>
    </div>
  </dialog>

  <dialog class="dialog" id="settings-dialog">
    <div class="dialog-header">
      <h2 class="dialog-title">Settings</h2>
      <button class="close-btn" onclick="closeSettingsDialog()">&times;</button>
    </div>
    <div class="dialog-content">
      <div class="settings-content">
        <div class="visual-settings-row">
          <label class="visual-setting">
            <input type="checkbox" id="visual-show-labels" onchange="toggleVisualSetting('show-labels', this.checked)">
            <span>Show Labels</span>
          </label>
          <label class="visual-setting">
            <input type="checkbox" id="visual-space-cells" onchange="toggleVisualSetting('space-cells', this.checked)">
            <span>Space Cells</span>
          </label>
          <label class="visual-setting">
            <input type="checkbox" id="visual-show-as-text"
              onchange="toggleVisualSetting('show-as-text', this.checked)">
            <span>Show as Text</span>
          </label>
          <label class="visual-setting">
            <input type="checkbox" id="visual-light-theme" onchange="toggleVisualSetting('light-theme', this.checked)">
            <span>Light Theme</span>
          </label>
          <div style="flex: 1;"></div>
          <label class="visual-setting">
            <span>Use LCH</span>
            <input type="checkbox" id="visual-use-lch" onchange="toggleVisualSetting('use-lch', this.checked)">
          </label>
        </div>

        <hr class="settings-divider" />

        <div class="settings-controls-row">
          <div class="css-section">
            <label for="preset-selector"><strong>Preset:</strong></label>
            <select id="preset-selector" onchange="applyPreset(this.value)">
              <option value="">Select a preset...</option>
            </select>
          </div>

          <div class="css-section">
            <label for="settings-hue-torsion"><strong>Hue Torsion:</strong></label>
            <input type="number" id="settings-hue-torsion" min="-50" max="50" step="1" value="0">
          </div>

          <div class="css-section">
            <label for="settings-chroma-reduction"><strong>Chroma Reduction:</strong></label>
            <input type="number" id="settings-chroma-reduction" min="0" max="100" step="1" value="50">
          </div>
        </div>

        <hr class="settings-divider" />

        <div class="settings-textareas-row">
          <div class="css-section">
            <label for="settings-shades"><strong>Lightness Scale:</strong></label>
            <textarea id="settings-shades" rows="8"
              placeholder='{"50": "98.5%", "100": "97%", "200": "92.2%"}'></textarea>
          </div>

          <div class="css-section">
            <label for="settings-colors"><strong>Colors:</strong></label>
            <textarea id="settings-colors" rows="8"
              placeholder='{"red": "#d13438", "blue": "#0078d4", "green": "#107c10"}'></textarea>
          </div>

          <div class="css-section">
            <label for="settings-grays"><strong>Grays:</strong></label>
            <textarea id="settings-grays" rows="4" placeholder='{"slate": "#859599", "zinc": "#394146"}'></textarea>
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="export-btn" onclick="applySettings()">Apply</button>
          <button class="export-btn" onclick="resetSettings()">Reset to Default</button>
        </div>

        <div id="settings-error" style="color: #ff6b6b; margin-top: 12px; display: none;"></div>
      </div>
    </div>
  </dialog>

  <dialog class="dialog" id="export-dialog">
    <div class="dialog-header">
      <h2 class="dialog-title">Export</h2>
      <button class="close-btn" onclick="closeExportDialog()">&times;</button>
    </div>
    <div class="dialog-content">
      <div class="export-format-selector">
        <div class="export-controls-row">
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="export-format" value="css-calc" checked onchange="updateExportFormat()">
              <span>CSS Calc</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="export-format" value="css-raw" onchange="updateExportFormat()">
              <span>CSS Raw</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="export-format" value="json" onchange="updateExportFormat()">
              <span>JSON</span>
            </label>
          </div>
          <button class="export-btn copy-btn" onclick="copyExportToClipboard()">Copy</button>
        </div>
      </div>

      <hr class="settings-divider" />

      <div class="css-section">
        <pre id="export-output"></pre>
      </div>
    </div>
  </dialog>

  <script id="grid-template" type="text/x-handlebars-template">
    <div class="color-grid" style="grid-template-columns: 1fr repeat({{shades.length}}, 1fr) 1fr">
      <!-- Header row -->
      <div class="header-cell" style="--l-shade: var(--l-0);">
        <span>W</span>
        <input type="number" class="lightness-input" data-shade="W" min="0" max="100" step="0.3" value="0" disabled>
      </div>
      {{#each shades}}
      <div class="header-cell" style="--l-shade: var(--l-{{this}});">
        <span>{{this}}</span>
        <input type="number" class="lightness-input" data-shade="{{this}}" min="0" max="100" step="0.3" value="0">
      </div>
      {{/each}}
      <div class="header-cell" style="--l-shade: var(--l-1000);"><span>B</span>
        <input type="number" class="lightness-input" data-shade="B" min="0" max="100" step="0.3" value="100" disabled>
      </div>

      <!-- Color rows -->
      {{#each colors}}
      <div class="color-name" style="--swatch: white;" title="{{this}}-white">
        <span>{{this}}</span>
        <input type="color" class="color-input" data-color="{{this}}" value="#000000">
      </div>
      {{#each ../shades}}
      <div class="color-cell" style="--swatch: var(--color-{{../this}}-{{this}});" title="{{../this}}-{{this}}">{{../this}}-{{this}}</div>
      {{/each}}
      <div class="color-cell" style="--swatch: black;" title="{{this}}-black">...</div>
      {{/each}}

      <!-- Gray rows -->
      {{#each grays}}
      <div class="color-name" style="--swatch: white;" title="{{this}}-white">
        <span>{{this}}</span>
        <input type="color" class="color-input" data-color="{{this}}" value="#000000">
      </div>
      {{#each ../shades}}
      <div class="color-cell" style="--swatch: var(--color-{{../this}}-{{this}});" title="{{../this}}-{{this}}">{{../this}}-{{this}}</div>
      {{/each}}
      <div class="color-cell" style="--swatch: black;" title="{{this}}-black">...</div>
      {{/each}}
    </div>
  </script>

  <script>
    // Global app state
    let appState = {};
    let visualSettings = {};

    // Palette presets
    const palettePresets = {
      "tailwind": {
        "shades": {
          50: "98.5%",
          100: "97%",
          200: "92.2%",
          300: "87%",
          400: "70.8%",
          500: "55.6%",
          600: "43.9%",
          700: "37.1%",
          800: "26.9%",
          900: "20.5%",
          950: "14.5%"
        },
        "colors": {
          red: "#d13438",
          orange: "#f7630c",
          amber: "#eaa300",
          yellow: "#fde300",
          lime: "#73aa24",
          green: "#107c10",
          emerald: "#00cc6a",
          teal: "#038387",
          cyan: "#0099bc",
          sky: "#3a96dd",
          blue: "#0078d4",
          indigo: "#004e8c",
          violet: "#4f6bed",
          purple: "#5c2e91",
          fuchsia: "#c239b3",
          pink: "#e43ba6",
          rose: "#c50f1f"
        },
        "grays": {
          slate: "#859599",
          gray: "#69797e",
          zinc: "#394146",
          neutral: "#000000",
          stone: "#7a7574"
        },
        "hue-torsion": 0,
        "chroma-reduction": 50
      },
      "fluent": {
        "shades": {
          "shade50": "17.875%",
          "shade40": "25.306%",
          "shade30": "37.69%",
          "shade20": "46.563%",
          "shade10": "52.614%",
          "primary": "56.77%",
          "tint10": "60.535%",
          "tint20": "64.81%",
          "tint30": "71.249%",
          "tint40": "84.734%",
          "tint50": "91.625%",
          "tint60": "97.874%"
        },
        "colors": {
          "darkred": "#750b1c",
          "burgundy": "#a4262c",
          "cranberry": "#c50f1f",
          "red": "#d13438",
          "darkorange": "#da3b01",
          "bronze": "#a74109",
          "pumpkin": "#ca5010",
          "orange": "#f7630c",
          "peach": "#ff8c00",
          "marigold": "#eaa300",
          "yellow": "#fde300",
          "gold": "#c19c00",
          "brass": "#986f0b",
          "brown": "#8e562e",
          "darkbrown": "#4d291c",
          "lime": "#73aa24",
          "forest": "#498205",
          "seafoam": "#00cc6a",
          "lightgreen": "#13a10e",
          "green": "#107c10",
          "darkgreen": "#0b6a0b",
          "lightteal": "#00b7c3",
          "teal": "#038387",
          "darkteal": "#006666",
          "cyan": "#0099bc",
          "steel": "#005b70",
          "lightblue": "#3a96dd",
          "blue": "#0078d4",
          "royalblue": "#004e8c",
          "darkblue": "#003966",
          "cornflower": "#4f6bed",
          "navy": "#0027b4",
          "lavender": "#7160e8",
          "purple": "#5c2e91",
          "darkpurple": "#401b6c",
          "orchid": "#8764b8",
          "grape": "#881798",
          "berry": "#c239b3",
          "lilac": "#b146c2",
          "pink": "#e43ba6",
          "hotpink": "#e3008c",
          "magenta": "#bf0077",
          "plum": "#77004d",
        },
        "grays": {
          "beige": "#7a7574",
          "mink": "#5d5a58",
          "silver": "#859599",
          "platinum": "#69797e",
          "anchor": "#394146",
          "charcoal": "#393939"
        },
        "hue-torsion": 0,
        "chroma-reduction": 50
      },
      "machine": {
        "shades": {
          1000: "100%",
          800: "80%",
          600: "60%",
          400: "40%",
          200: "20%",
          0: "0%"
        },
        "colors": {
          red: "red",
          green: "green",
          blue: "blue"
        },
        "grays": {},
        "hue-torsion": 0,
        "chroma-reduction": 50
      }
    };

    // Load app state from localStorage or use default
    function loadAppState() {
      try {
        const stored = localStorage.getItem('css-color-grid-state');
        if (stored) {
          appState = JSON.parse(stored);
        } else {
          appState = JSON.parse(JSON.stringify(palettePresets.tailwind));
        }
      } catch (error) {
        console.error('Failed to load app state:', error);
        appState = JSON.parse(JSON.stringify(palettePresets.tailwind));
      }
    }

    // Load visual settings from localStorage or use default
    function loadVisualSettings() {
      try {
        const stored = localStorage.getItem('css-color-grid-visual-settings');
        if (stored) {
          visualSettings = JSON.parse(stored);
        } else {
          visualSettings = {
            'show-labels': false,
            'space-cells': false,
            'show-as-text': false,
            'light-theme': false,
            'use-lch': false
          };
        }
      } catch (error) {
        console.error('Failed to load visual settings:', error);
        visualSettings = {
          'show-labels': false,
          'space-cells': false,
          'show-as-text': false,
          'light-theme': false,
          'use-lch': false
        };
      }
    }

    // Save visual settings to localStorage
    function saveVisualSettings() {
      try {
        localStorage.setItem('css-color-grid-visual-settings', JSON.stringify(visualSettings));
      } catch (error) {
        console.error('Failed to save visual settings:', error);
      }
    }

    // Apply visual settings to body classes
    function applyVisualSettings() {
      Object.entries(visualSettings).forEach(([setting, enabled]) => {
        const className = `APPSETTING-${setting}`;
        if (enabled) {
          document.body.classList.add(className);
        } else {
          document.body.classList.remove(className);
        }
      });
    }

    // Toggle visual setting
    function toggleVisualSetting(setting, enabled) {
      visualSettings[setting] = enabled;
      saveVisualSettings();

      // Special handling for 'use-lch' - it affects CSS generation, not body classes
      if (setting === 'use-lch') {
        generateAndInjectCSS();
      } else {
        applyVisualSettings();
      }
    }

    // Save app state to localStorage
    function saveAppState() {
      try {
        localStorage.setItem('css-color-grid-state', JSON.stringify(appState));
      } catch (error) {
        console.error('Failed to save app state:', error);
      }
    }

    // Update app state and trigger CSS regeneration
    function updateAppState(updates) {
      Object.assign(appState, updates);
      saveAppState();
      generateAndInjectCSS();
      updateUIControls();
    }

    // Generate CSS from app state
    function generateCSSFromState() {
      const shadeKeys = Object.keys(appState.shades).filter(key => {
        const value = parseFloat(appState.shades[key]);
        return value !== 0 && value !== 100;
      }).sort((a, b) => parseFloat(appState.shades[a]) - parseFloat(appState.shades[b]));

      // Generate symmetric steps for chroma and hue adjustments
      function generateSymmetricSteps(count, min, max) {
        if (count === 1) return [0];
        const arr = [];
        for (let i = 0; i < count; i++) {
          const t = i / (count - 1);
          const value = min + (max - min) * t;
          arr.push(Math.round(value * 10) / 10);
        }
        return arr;
      }

      const chromaX = generateSymmetricSteps(shadeKeys.length, -1, -1).map((v, i, arr) => {
        const mid = (arr.length - 1) / 2;
        if (arr.length % 2 === 1) {
          return i <= mid ? -1 + (i / mid) * (1) : 0 - ((i - mid) / mid) * (1);
        } else {
          return i < mid ? -1 + (i / mid) * (1) : 0 - ((i - mid) / mid) * (1);
        }
      }).map(v => Math.round(v * 100) / 100);

      const hueX = generateSymmetricSteps(shadeKeys.length, -1, 1).map(v => Math.round(v * 100) / 100);

      // Generate source CSS
      let sourceCSS = ":root {\n";

      // Lightness scale
      sourceCSS += "  /* lightness scale */\n";
      sourceCSS += "  --l-0: 100%;\n";
      Object.entries(appState.shades).forEach(([key, value]) => {
        sourceCSS += `  --l-${key}: ${value};\n`;
      });
      sourceCSS += "  --l-1000: 0%;\n";

      // Controls
      sourceCSS += "\n  /* hue torsion */\n";
      sourceCSS += `  --h-x: ${appState['hue-torsion']};\n`;
      sourceCSS += "\n  /* chroma reduction */\n";
      sourceCSS += `  --c-x: ${appState['chroma-reduction']};\n`;

      // Source colors
      sourceCSS += "\n  /* source colors */\n";
      Object.entries(appState.colors).forEach(([key, value]) => {
        sourceCSS += `  --${key}: ${value};\n`;
      });

      // Source grays
      if (Object.keys(appState.grays).length > 0) {
        sourceCSS += "\n  /* source grays */\n";
        Object.entries(appState.grays).forEach(([key, value]) => {
          sourceCSS += `  --${key}: ${value};\n`;
        });
      }

      sourceCSS += "}\n";

      // Generate color variations CSS
      let colorCSS = ":root {\n";

      const useLCH = visualSettings['use-lch'] || false;
      const lch = useLCH ? 'lch' : 'oklch';
      const chromaCoefficient = useLCH ? 1 : 500;

      // Color variations
      Object.keys(appState.colors).forEach(color => {
        shadeKeys.forEach((shade, index) => {
          colorCSS += `  --color-${color}-${shade}: ${lch}(from var(--${color}) var(--l-${shade}) calc((var(--c-x) * ${chromaX[index]} / ${chromaCoefficient}) + c) calc((var(--h-x) * ${hueX[index]}) + h));\n`;
        });
        colorCSS += `\n`
      });

      // Gray variations
      Object.keys(appState.grays).forEach(gray => {
        shadeKeys.forEach(shade => {
          colorCSS += `  --color-${gray}-${shade}: ${lch}(from var(--${gray}) var(--l-${shade}) c h);\n`;
        });
        colorCSS += `\n`
      });

      colorCSS += `  --color-white: ${lch}(100% 0 0);\n`;
      colorCSS += `  --color-black: ${lch}(0% 0 0);\n`;
      colorCSS += "}\n";

      return { sourceCSS, colorCSS };
    }

    // Inject generated CSS into the page
    function generateAndInjectCSS() {
      const { sourceCSS, colorCSS } = generateCSSFromState();

      // Inject source CSS
      let sourceStyleElement = document.getElementById('source-colors');
      if (!sourceStyleElement) {
        sourceStyleElement = document.createElement('style');
        sourceStyleElement.id = 'source-colors';
        document.head.appendChild(sourceStyleElement);
      }
      sourceStyleElement.textContent = sourceCSS;

      // Inject generated color CSS
      let colorStyleElement = document.getElementById('generated-colors');
      if (!colorStyleElement) {
        colorStyleElement = document.createElement('style');
        colorStyleElement.id = 'generated-colors';
        document.head.appendChild(colorStyleElement);
      }
      colorStyleElement.textContent = colorCSS;
    }

    // Update UI controls to match app state
    function updateUIControls() {
      // Update sliders
      const hueSlider = document.getElementById('hue-torsion');
      const chromaSlider = document.getElementById('chroma-reduction');
      const hueValue = document.getElementById('hue-value');
      const chromaValue = document.getElementById('chroma-value');

      if (hueSlider) {
        hueSlider.value = appState['hue-torsion'];
        hueValue.textContent = appState['hue-torsion'];
      }
      if (chromaSlider) {
        chromaSlider.value = appState['chroma-reduction'];
        chromaValue.textContent = appState['chroma-reduction'];
      }
    }

    // Render the grid based on app state
    function renderGrid() {
      const source = document.getElementById('grid-template').innerHTML;
      const template = Handlebars.compile(source);

      const shadeKeys = Object.keys(appState.shades).filter(key => {
        const value = parseFloat(appState.shades[key]);
        return value !== 0 && value !== 100;
      }).sort((a, b) => parseFloat(appState.shades[b]) - parseFloat(appState.shades[a]));

      const data = {
        colors: Object.keys(appState.colors),
        grays: Object.keys(appState.grays),
        shades: shadeKeys
      };

      const html = template(data);
      document.getElementById('color-grid-container').innerHTML = html;

      // Setup event listeners
      setTimeout(() => {
        setupColorInputs();
        setupLightnessInputs();
      }, 0);
    }

    // Setup color input event listeners
    function setupColorInputs() {
      const colorInputs = document.querySelectorAll('.color-input');

      colorInputs.forEach(input => {
        const colorName = input.dataset.color;
        const colorValue = appState.colors[colorName] || appState.grays[colorName];
        if (colorValue) {
          input.value = colorValue;
        }

        input.addEventListener('input', function () {
          if (appState.colors[colorName] !== undefined) {
            updateAppState({ colors: { ...appState.colors, [colorName]: this.value } });
          } else if (appState.grays[colorName] !== undefined) {
            updateAppState({ grays: { ...appState.grays, [colorName]: this.value } });
          }
        });
      });
    }

    // Setup lightness input event listeners
    function setupLightnessInputs() {
      const lightnessInputs = document.querySelectorAll('.lightness-input');

      lightnessInputs.forEach(input => {
        const shade = input.dataset.shade;
        if (appState.shades[shade]) {
          input.value = parseFloat(appState.shades[shade]);
        }

        input.addEventListener('input', function () {
          if (appState.shades[shade] !== undefined) {
            updateAppState({ shades: { ...appState.shades, [shade]: `${this.value}%` } });
          }
        });
      });
    }

    // Slider event handlers
    function updateHueTorsion(value) {
      updateAppState({ 'hue-torsion': parseInt(value) });
    }

    function updateChromaReduction(value) {
      updateAppState({ 'chroma-reduction': parseInt(value) });
    }

    // Populate preset selector with available presets
    function populatePresetSelector() {
      const selector = document.getElementById('preset-selector');

      // Clear existing options except the first one
      while (selector.children.length > 1) {
        selector.removeChild(selector.lastChild);
      }

      // Add options for each preset
      Object.keys(palettePresets).forEach(presetKey => {
        const option = document.createElement('option');
        option.value = presetKey;
        option.textContent = presetKey.charAt(0).toUpperCase() + presetKey.slice(1);
        selector.appendChild(option);
      });
    }

    // Settings dialog functions
    function openSettingsDialog() {
      const dialog = document.getElementById('settings-dialog');

      // Populate preset selector
      populatePresetSelector();

      // Populate visual settings checkboxes
      document.getElementById('visual-show-labels').checked = visualSettings['show-labels'];
      document.getElementById('visual-space-cells').checked = visualSettings['space-cells'];
      document.getElementById('visual-show-as-text').checked = visualSettings['show-as-text'];
      document.getElementById('visual-light-theme').checked = visualSettings['light-theme'];
      document.getElementById('visual-use-lch').checked = visualSettings['use-lch'];

      // Populate textareas with current state
      document.getElementById('settings-shades').value = JSON.stringify(appState.shades, null, 2);
      document.getElementById('settings-colors').value = JSON.stringify(appState.colors, null, 2);
      document.getElementById('settings-grays').value = JSON.stringify(appState.grays, null, 2);
      document.getElementById('settings-hue-torsion').value = appState['hue-torsion'];
      document.getElementById('settings-chroma-reduction').value = appState['chroma-reduction'];

      // Clear any error messages
      document.getElementById('settings-error').style.display = 'none';

      dialog.showModal();
    }

    function closeSettingsDialog() {
      document.getElementById('settings-dialog').close();
    }

    function applyPreset(presetName) {
      if (presetName && palettePresets[presetName]) {
        updateAppState(JSON.parse(JSON.stringify(palettePresets[presetName])));
        renderGrid();

        // Update settings dialog if it's open
        if (document.getElementById('settings-dialog').open) {
          openSettingsDialog();
        }
      }
    }

    function applySettings() {
      const errorDiv = document.getElementById('settings-error');

      try {
        const shades = JSON.parse(document.getElementById('settings-shades').value);
        const colors = JSON.parse(document.getElementById('settings-colors').value);
        const grays = JSON.parse(document.getElementById('settings-grays').value);
        const hueTorsion = parseInt(document.getElementById('settings-hue-torsion').value);
        const chromaReduction = parseInt(document.getElementById('settings-chroma-reduction').value);

        // Validation
        if (typeof shades !== 'object' || typeof colors !== 'object' || typeof grays !== 'object') {
          throw new Error('All JSON fields must be objects');
        }

        updateAppState({
          shades,
          colors,
          grays,
          'hue-torsion': hueTorsion,
          'chroma-reduction': chromaReduction
        });

        renderGrid();
        closeSettingsDialog();

      } catch (error) {
        errorDiv.textContent = `Error: ${error.message}`;
        errorDiv.style.display = 'block';
      }
    }

    function resetSettings() {
      updateAppState(JSON.parse(JSON.stringify(palettePresets.tailwind)));
      renderGrid();

      // Update settings dialog if it's open
      if (document.getElementById('settings-dialog').open) {
        openSettingsDialog();
      }
    }


    const colophon = `/*\n CSS UniPalette\n https://github.com/arniebradfo/\n*/\n`;

    // Export functions
    function generateCombinedCSS() {
      const { sourceCSS, colorCSS } = generateCSSFromState();
      return `${colophon}\n/* SOURCE COLORS - edit to update palette */\n${sourceCSS}\n\n/* GENERATED COLORS - no need to edit, derived from source colors */\n${colorCSS}`;
    }

    function generateRawCSS() {
      const shadeKeys = Object.keys(appState.shades).filter(key => {
        const value = parseFloat(appState.shades[key]);
        return value !== 0 && value !== 100;
      }).sort((a, b) => parseFloat(appState.shades[b]) - parseFloat(appState.shades[a]));

      const computedStyle = getComputedStyle(document.documentElement);
      let css = colophon;
      css += ":root {\n";


      function getCalculatedValue(varName) {
        // potentially slow because of the document.body.appendChild and getComputedStyle...
        const temp = document.createElement("div");
        temp.style.backgroundColor = varName;
        document.body.appendChild(temp);
        const calculatedValue = getComputedStyle(temp).backgroundColor;
        document.body.removeChild(temp);
        return calculatedValue;
      }

      // Get computed values for color variations
      [...Object.keys(appState.colors), ...Object.keys(appState.grays)].forEach(color => {
        shadeKeys.forEach(shade => {
          const varName = `--color-${color}-${shade}`;
          const computedValue = computedStyle.getPropertyValue(varName).trim();
          let calculatedValue = computedValue;
          if (computedValue) {
            calculatedValue = getCalculatedValue(computedValue);
            css += `  ${varName}: ${calculatedValue};\n`;
          }
        });
        css += "\n";
      });


      // Add white and black
      const whiteValue = computedStyle.getPropertyValue('--color-white').trim();
      const blackValue = computedStyle.getPropertyValue('--color-black').trim();
      if (whiteValue) css += `  --color-white: ${whiteValue};\n`;
      if (blackValue) css += `  --color-black: ${blackValue};\n`;

      css += "}\n";
      return css;
    }

    function generateJSONExport() {
      return `${colophon}\n${JSON.stringify(appState, null, 2)}`;
    }

    function updateExportFormat() {
      const selectedFormat = document.querySelector('input[name="export-format"]:checked').value;
      const exportOutput = document.getElementById('export-output');

      let content = '';
      switch (selectedFormat) {
        case 'css-calc':
          content = generateCombinedCSS();
          break;
        case 'css-raw':
          content = generateRawCSS();
          break;
        case 'json':
          content = generateJSONExport();
          break;
      }

      exportOutput.textContent = content;
    }

    function openExportDialog() {
      const dialog = document.getElementById('export-dialog');

      // Set default format and generate content
      document.querySelector('input[name="export-format"][value="css-calc"]').checked = true;
      updateExportFormat();

      dialog.showModal();
    }

    function closeExportDialog() {
      document.getElementById('export-dialog').close();
    }

    function copyExportToClipboard() {
      const exportOutput = document.getElementById('export-output');
      const content = exportOutput.textContent;

      if (navigator.clipboard && window.isSecureContext) {
        // Use the modern clipboard API
        navigator.clipboard.writeText(content).then(() => {
          // Provide visual feedback
          const copyBtn = document.querySelector('.copy-btn');
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'Copied!';
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 1500);
        }).catch(err => {
          console.error('Failed to copy: ', err);
          fallbackCopyTextToClipboard(content);
        });
      } else {
        // Fallback for older browsers
        fallbackCopyTextToClipboard(content);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.left = "-999999px";
      textArea.style.top = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        const successful = document.execCommand('copy');
        if (successful) {
          // Provide visual feedback
          const copyBtn = document.querySelector('.copy-btn');
          const originalText = copyBtn.textContent;
          copyBtn.textContent = 'Copied!';
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 1500);
        }
      } catch (err) {
        console.error('Fallback: Could not copy text: ', err);
      }

      document.body.removeChild(textArea);
    }

    // About dialog functions
    function openAboutDialog() {
      document.getElementById('about-dialog').showModal();
    }

    function closeAboutDialog() {
      document.getElementById('about-dialog').close();
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function () {
      loadAppState();
      loadVisualSettings();
      applyVisualSettings();
      generateAndInjectCSS();
      renderGrid();
      updateUIControls();
    });
  </script>
</body>

</html>